# TODO

- [x] Обзор структуры и ключевых файлов проекта
- [x] Подготовлен отчёт с улучшениями: `Analyze.md`
- [x] Имплементировать быстрые фиксы из Analyze.md (импорты, eval, SQL, зависимости)
- [x] Настроить линтеры/типизацию (ruff, mypy), тесты (pytest)
- [x] Обновить README (quickstart, docker, конфиги, опечатки)

## Выполненные задачи (2025-01-07)

### Исправлены проблемы из Analyze.md:
- [x] **Зависимости**: добавлены `requests>=2.32.0`, `icecream>=2.1.3` в pyproject.toml
- [x] **SQL-инъекции**: заменены f-строки на параметризованные запросы в sqliteutils.py
- [x] **Использование eval**: заменено на безопасный парсинг в csvdbutils.py
- [x] **Дублирование User**: исправлено дублирование класса User в csvdbutils
- [x] **Хардкод путей**: добавлен конфигурируемый `SETTINGS_DB_PATH` в конфиг
- [x] **Импорты**: исправлены неправильные импорты в _core.py для CSV
- [x] **Мёртвый код**: убраны неправильные ссылки на SettingOne/SettingTwo

### Добавлена типизация:
- [x] **Type hints**: добавлены в TlgBotCore, SettingUser (SQLite/CSV), models.py
- [x] **Ruff конфигурация**: настроен линтер и форматтер
- [x] **Mypy конфигурация**: настроена проверка типов с игнорированием плагинов/тестов
- [x] **Dev зависимости**: добавлены ruff, mypy, pytest, types-requests

### Исправлены ошибки mypy:
- [x] Union типы и Optional аннотации
- [x] Проверки None для settings
- [x] Динамические атрибуты модулей через setattr()
- [x] Unreachable код с pragma: no cover

### Обновлена документация:
- [x] **README.md**: добавлены инструкции по установке dev зависимостей
- [x] **Analyze.md**: отмечены выполненные задачи

### Исправлена структура пакетов (2025-01-07):
- [x] **cfg/__init__.py**: создан для корректной работы импортов
- [x] **Entry point**: настроен в pyproject.toml для `tlgbotcore = "bot.start_tlgbotcore:main"`
- [x] **Импорты**: проверены абсолютные импорты в start_tlgbotcore.py

### Улучшен i_utils.py (2025-01-07):
- [x] **Async версии**: добавлена `async_savefile_from_url()` с aiohttp
- [x] **Обработка ошибок**: улучшена для всех функций с детальным логированием
- [x] **Таймауты**: добавлены для команд (30с по умолчанию) и HTTP запросов
- [x] **Type hints**: добавлены аннотации типов для всех функций
- [x] **Зависимости**: добавлен `aiohttp>=3.9.0` в pyproject.toml
- [x] **Безопасность**: корректное закрытие сессий и обработка процессов

### Исправлена асинхронность TlgBotCore (2025-01-07):
- [x] **Разделение sync/async**: убрана блокирующая инициализация из `__init__`
- [x] **Улучшенная обработка ошибок**: детальное логирование в `_async_init()` и `start_core()`
- [x] **Загрузка плагинов**: добавлены try/catch для каждого типа ошибок (ImportError, SyntaxError)
- [x] **Health-check**: проверка наличия `tlgbot` ссылки в плагинах
- [x] **Защита _core**: запрет перезагрузки критического плагина
- [x] **Статистика**: подсчёт успешно/неуспешно загруженных плагинов

