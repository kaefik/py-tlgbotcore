# TODO

- [x] Обзор структуры и ключевых файлов проекта
- [x] Подготовлен отчёт с улучшениями: `Analyze.md`
- [x] Имплементировать быстрые фиксы из Analyze.md (импорты, eval, SQL, зависимости)
- [x] Настроить линтеры/типизацию (ruff, mypy), тесты (pytest)
- [x] Обновить README (quickstart, docker, конфиги, опечатки)

## Выполненные задачи (2025-01-07)

### Исправлены проблемы из Analyze.md:
- [x] **Зависимости**: добавлены `requests>=2.32.0`, `icecream>=2.1.3` в pyproject.toml
- [x] **SQL-инъекции**: заменены f-строки на параметризованные запросы в sqliteutils.py
- [x] **Использование eval**: заменено на безопасный парсинг в csvdbutils.py
- [x] **Дублирование User**: исправлено дублирование класса User в csvdbutils
- [x] **Хардкод путей**: добавлен конфигурируемый `SETTINGS_DB_PATH` в конфиг
- [x] **Импорты**: исправлены неправильные импорты в _core.py для CSV
- [x] **Мёртвый код**: убраны неправильные ссылки на SettingOne/SettingTwo

### Добавлена типизация:
- [x] **Type hints**: добавлены в TlgBotCore, SettingUser (SQLite/CSV), models.py
- [x] **Ruff конфигурация**: настроен линтер и форматтер
- [x] **Mypy конфигурация**: настроена проверка типов с игнорированием плагинов/тестов
- [x] **Dev зависимости**: добавлены ruff, mypy, pytest, types-requests

### Исправлены ошибки mypy:
- [x] Union типы и Optional аннотации
- [x] Проверки None для settings
- [x] Динамические атрибуты модулей через setattr()
- [x] Unreachable код с pragma: no cover

### Обновлена документация:
- [x] **README.md**: добавлены инструкции по установке dev зависимостей
- [x] **Analyze.md**: отмечены выполненные задачи

### Исправлена структура пакетов (2025-01-07):
- [x] **cfg/__init__.py**: создан для корректной работы импортов
- [x] **Entry point**: настроен в pyproject.toml для `tlgbotcore = "bot.start_tlgbotcore:main"`
- [x] **Импорты**: проверены абсолютные импорты в start_tlgbotcore.py

### Улучшен i_utils.py (2025-01-07):
- [x] **Async версии**: добавлена `async_savefile_from_url()` с aiohttp
- [x] **Обработка ошибок**: улучшена для всех функций с детальным логированием
- [x] **Таймауты**: добавлены для команд (30с по умолчанию) и HTTP запросов
- [x] **Type hints**: добавлены аннотации типов для всех функций
- [x] **Зависимости**: добавлен `aiohttp>=3.9.0` в pyproject.toml
- [x] **Безопасность**: корректное закрытие сессий и обработка процессов

### Исправлена асинхронность TlgBotCore (2025-01-07):
- [x] **Разделение sync/async**: убрана блокирующая инициализация из `__init__`
- [x] **Улучшенная обработка ошибок**: детальное логирование в `_async_init()` и `start_core()`
- [x] **Загрузка плагинов**: добавлены try/catch для каждого типа ошибок (ImportError, SyntaxError)
- [x] **Health-check**: проверка наличия `tlgbot` ссылки в плагинах
- [x] **Защита _core**: запрет перезагрузки критического плагина
- [x] **Статистика**: подсчёт успешно/неуспешно загруженных плагинов

### Улучшено логирование (2025-01-07):
- [x] **Цветное логирование**: ColoredFormatter для консоли с цветами по уровням
- [x] **Файловые логи**: опциональная запись в файл с детальной информацией (номера строк)
- [x] **Уровни библиотек**: приглушены логи telethon, aiohttp, urllib3
- [x] **icecream**: убран из продакшн зависимостей, перенесён в dev, автоотключение
- [x] **Режимы**: setup_prod_logging() и setup_dev_logging() для разных сред
- [x] **dev_start.py**: отдельный скрипт для разработки с DEBUG логами

### Обновлена документация README.md (2025-01-07):
- [x] **Структура**: современный markdown с эмодзи и чёткими разделами
- [x] **Quickstart**: пошаговая инструкция с `uv sync` и `uv run tlgbotcore`
- [x] **Переменные окружения**: альтернатива config файлам для Docker/CI
- [x] **Docker**: исправлены примеры без хардкод путей, добавлен docker-compose
- [x] **Systemd**: корректный сервис-файл для продакшена
- [x] **Инструменты разработки**: команды для ruff, mypy, pytest
- [x] **Убраны**: нерелевантные блоки про YouTube, исправлены опечатки "slite3"

### Улучшен Docker (2025-01-07):
- [x] **Современный Dockerfile**: Python 3.12-slim, uv, непривилегированный пользователь
- [x] **HEALTHCHECK**: проверка доступности БД каждые 30 секунд
- [x] **docker-compose.yml**: полная конфигурация с переменными окружения
- [x] **.env.example**: шаблон для переменных окружения
- [x] **.dockerignore**: исключение секретов и временных файлов
- [x] **Безопасность**: отдельный пользователь tlgbot, персистентные volumes
- [x] **Логирование**: ротация логов, health check, expose порта 8080

### Внедрение зависимостей (DI) - 2025-01-08:
- [x] **DI-контейнер**: создан `di_container.py` с интерфейсами IConfig, ISettingsStorage
- [x] **Фабрика хранилищ**: `storage_factory.py` для создания SQLite/CSV хранилищ
- [x] **Рефакторинг TlgBotCore**: убрана условная логика создания БД из конструктора
- [x] **Внедрение зависимостей**: TlgBotCore теперь принимает готовое хранилище через `settings_storage`
- [x] **Обновлён start_tlgbotcore.py**: использует DI-контейнер вместо прямых импортов
- [x] **Пример использования**: `examples/di_usage_example.py` демонстрирует новую архитектуру

