# Analyze: py-tlgbotcore

## Ключевые находки
- **Структура**: проект разделён на ядро бота `bot/tlgbotcore`, плагины `bot/plugins_bot`, конфиги `cfg`. Запуск через `bot/start_tlgbotcore.py`.
- **Зависимости**: только `telethon>=1.41.2` в `pyproject.toml`. Используются `requests`, `icecream` (в коде), но не задекларированы.
- **Pythон/UV**: `requires-python = ">=3.12"`, есть `uv.lock` — ок.
- **Хранилища**: два варианта: SQLite (`sqliteutils.py`) и CSV (`csvdbutils.py`). Разный уровень качества кода и согласованности API.
- **Плагины**: автозагрузка всех `*.py` в подпапках `bot/plugins_bot/*/`. Есть системный `_core`.
- **Документация**: README неполный/устаревший (docker пример с youtube-сервисом, опечатки `slite3`). Есть docs по плагинам.
- **Тесты**: есть модульные тесты для CSV/SQLite-утилит, но нет тестов для ядра бота и плагинов.

## Проблемы
1. **Зависимости не полные**: используются `requests`, `icecream`, но отсутствуют в `pyproject.toml`. — СДЕЛАНО
2. **Импорт для TYPE_DB в `_core.py`**: при `CSV` импортируется `tlgbotcore.sqliteutils.User` — несоответствие. — СДЕЛАНО
3. **Дублирование и несогласованность моделей `User/Role`** в `sqliteutils` и `csvdbutils` (разные конструкторы, обработка `active`, `eval` в CSV-версии — небезопасно). — СДЕЛАНО
4. **SQL-инъекции**: в `sqliteutils.py` SQL строится через f-строки, без параметров. — СДЕЛАНО
5. **Режимы бота и права**: логику админов/доступа лучше централизовать; сейчас список админов в БД дублируется параметром `admins`. — СДЕЛАНО
6. **Логирование**: базовая настройка `logging.basicConfig(level=INFO)`, нет форматирования/хендлеров, уровень утечек (print/icecream) в библиотечном коде. — СДЕЛАНО
7. **Пути/импорты**: в `start_tlgbotcore.py` мутируется `sys.path`; лучше использовать пакетную структуру/entry point. — СДЕЛАНО
8. **Асинхронность**: `run_until_complete` вызывается в `__init__` клиента, блокирующая инициализация + смешение sync/async.
9. **Безопасность**: хранение конфигов в открытом виде; нет `.env`/секретов; нет маскировки логов.
10. **API загрузки плагинов**: отсутствие try/except на уровне загрузки файла может падать весь бот; горячая перезагрузка `_core` запрещена — ок, но нет health-check плагинов. — СДЕЛАНО
11. **Документация/README**: отдельные блоки нерелевантны, опечатки, нет quickstart с `uv run` и переменными.
12. **Docker**: есть `Dockerfile`, но README пример run жёстко прибит путями; нет compose, нет HEALTHCHECK.
13. **Типы**: почти нет type hints, нет mypy/ruff/flake8 конфигов.
14. **Тесты**: нет интеграционных тестов бота (загрузка плагинов, команды, ACL).
15. **Набор утилит `i_utils.py`**: синхронные сетевые вызовы (`requests`) и `print` в библиотеке; нет таймаутов, нет исключений. — СДЕЛАНО
16. **Хардкод путей**: `settings.db` в корне; лучше конфигурируемый путь.
17. **Неправильные Enum-ссылки**: в `sqliteutils.User` используются `SettingOne/SettingTwo`, которые закомментированы — невалидный код (атрибуты доступны, но классы комментированы; обращение к ним в `__init__` приведёт к NameError при первой ветке конструктора; сейчас переопределено вторым `__init__`). Два `__init__` подряд — первый мёртвый код. — СДЕЛАНО
18. **Использование `eval` в CSV-слое**: парсинг bool через `eval(el['active'])` — опасно. — СДЕЛАНО

## Улучшения (пошагово)
1. Зависимости: добавить `requests>=2`, опционально `python-dotenv`, убрать `icecream` из прод или пометить как dev.
2. Линтеры/форматирование: подключить `ruff` (lint+format), `mypy` (strict=True постепенно), `pytest` как тест-раннер.
3. Типизация: добавить type hints в публичные API `TlgBotCore`, storage классы, плагины.
4. Безопасность SQL: заменить f-строки на параметризованные запросы (`?` в sqlite3).
5. Унифицировать модель `User/Role`: один модуль `models.py`, переиспользовать в sqlite/csv backends.
6. Убрать второй `__init__` и мёртвый код `SettingOne/SettingTwo`; хранить пользовательские настройки отдельно.
7. CSV backend: заменить `eval` на явный парсинг (`active in {"1","true","True"}`), хранить bool как `0/1`.
8. Инверсии зависимостей: в `TlgBotCore` принимать абстракцию `SettingsRepository` с реализациями `SQLiteSettingsRepo`/`CSVSettingsRepo`.
9. Инициализация клиента: вынести асинхронный старт из `__init__` в `async def start_bot()`; не блокировать в конструкторе.
10. Логирование: настроить форматтер, уровни, убрать `print`, удалить `icecream`.
11. Плагины: при загрузке оборачивать `exec_module` в try/except; добавлять отчёт об ошибке, продолжать загрузку; добавить валидацию наличия `tlgbot`.
12. Конфиги: перейти на `.env`/`ENV` с `python-dotenv`; не мутировать `sys.path`, оформить CLI/entry point `tlgbotcore`.
13. Докер: добавить `HEALTHCHECK`, `ENV` для секретов, неблокирующий запуск; пример `docker run` без абсолютных путей; optional `docker-compose`.
14. Тесты: добавить e2e тест загрузки фейкового плагина; мокать Telethon, тестировать команды `_core`.
15. README: обновить quickstart, исправить опечатки, добавить раздел «Разработка» (lint/test/format).
16. Путь БД: вынести путь `settings.db` в конфиг; поддержать миграции (версия схемы).
17. Стиль API команд: объединить `cmd/admin_cmd` и документировать шаблоны.
18. CI: добавить GitHub Actions: lint, mypy, tests, build docker.

## Быстрые фиксы (минимальные PR’ы)
- Правка импорта в `_core.py` для CSV (должно быть `from tlgbotcore.csvdbutils import User`). — СДЕЛАНО
- Убрать дубли `__init__` и мёртвые ссылки на `SettingOne/SettingTwo` в обоих backend’ах.
- SQL: параметризовать `INSERT/UPDATE/DELETE/SELECT`. — СДЕЛАНО
- Добавить `requests` в зависимости. — СДЕЛАНО
- Заменить `eval` на безопасный парсинг. — СДЕЛАНО

## Риски/долги
- Смешение sync/async может приводить к блокировкам.
- Отсутствие параметризованных SQL — риск инъекций.
- Плагины могут падать при загрузке и валить процесс.

## Предложение roadmap (итерации)
1) Чистка кода и безопасность (SQL, eval, дубли, логирование, зависимости).
2) Типизация и лэйеры (модель, репозитории, инициализация).
3) Тесты и CI.
4) Документация, Docker/ENV, entrypoint.

